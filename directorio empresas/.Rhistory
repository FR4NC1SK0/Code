directorio <- "R:/Datos/Directorios/EMPRESAS/Directorios_elaboraci칩n/DIRGA/DIRGA 24/MASTER"
setwd(directorio)
directorio <- "R:\Servicios\Master\Alejandro Romero Rivas\Directrorio empresas"
directorio <- "R:/Servicios/Master/Alejandro Romero Rivas/Directrorio empresas"
setwd(directorio)
getwd()
if ("pacman" %in% rownames(installed.packages()) == FALSE) {
install.packages("pacman")
}
pacman::p_load(readxl, tidyverse, writexl, fuzzyjoin)
getwd()
bancos_2021 <-
read_excel(path = "EstablecBancos_BcoEspa침a.xlsx", sheet = "2021")
bancos_2022 <-
read_excel(path = "EstablecBancos_BcoEspa침a.xlsx", sheet = "2022")
bancos_DIRGA <-
read_excel(path = "DIRGA_Ent_Financieras_Locais.xlsx")
bancos_union <-
bancos_2021 %>% full_join(bancos_2022,
by = c("NIF_Entidad", "Cod_Prov", "Cod_Mun", "Domicilio"))
bancos_union <-
bancos_2021 %>% full_join(bancos_2022,
by = c("NIF_Entidad", "Cod_Prov", "Cod_Mun", "Domicilio"))
View(bancos_union)
bancos_2021_dupli <-
bancos_2021 %>% group_by (NIF_Entidad, Cod_Prov, Cod_Mun, Domicilio) %>%
filter(n() > 1) %>% ungroup()
bancos_2022_dupli <-
bancos_2022 %>% group_by (NIF_Entidad, Cod_Prov, Cod_Mun, Domicilio) %>%
filter(n() > 1) %>% ungroup()
duplicados_union <- bancos_union %>%
group_by (NIF_Entidad, Cod_Prov, Cod_Mun, Domicilio) %>%
filter(n() > 1) %>% ungroup()
bancos_altas <- bancos_union %>% filter(is.na(ID.x))
bancos_bajas <- bancos_union %>% filter(is.na(ID.y))
bancos_bajas <- select(bancos_bajas,-ends_with(".y"))
View(bancos_DIRGA)
View(bancos_bajas)
patron <-
"av\\.|avda\\.|c\\.|ca\\.|cl\\.|cr\\.|ctra\\.|pg\\.|s/n|sn\\.|s-n|rua"
bancos_bajas <- bancos_bajas %>%
mutate(Cod_Mun = str_pad(Cod_Mun, width = 3, pad = "0")) %>%
mutate(tipo_via = str_sub(Domicilio, 1, 2),
via = str_to_lower(str_sub(Domicilio, 4))) %>%
mutate(via2 = str_replace_all(via, paste(patron, collapse = "|"), "")) %>%
mutate(via2 = str_remove_all(via2, "[^[:alpha:]]"))
View(bancos_bajas)
bancos_bajas <- bancos_bajas %>%
mutate(Nvia = str_extract(via, "\\d+")) %>%
mutate(Nvia = as.numeric(Nvia)) %>%
mutate(Nvia = if_else(is.na(Nvia), 0, Nvia))
bancos_DIRGA <- bancos_DIRGA %>%
mutate(via2 = str_replace_all(via, "\\(.*?\\)", "")) %>%
mutate(via2 = str_remove_all(via2, "[^[:alpha:]]")) %>%
mutate(via2=  str_to_lower(via2)) %>%
mutate(nvia = if_else(is.na(nvia), 0, nvia))
bancos_bajas <-
bancos_bajas %>% mutate(enlace = paste(NIF_Entidad, Cod_Prov, Cod_Mun, via2, sep = "_"))
bancos_DIRGA <-
bancos_DIRGA %>% mutate(enlace = paste(nif, provincia, codigo_concello, via2, sep = "_"))
bajas_DIRGA <- stringdist_join(
bancos_bajas,
bancos_DIRGA,
by = c("enlace"),
method = "lv",
max_dist = 4,
distance_col = "distancia"
)
View(bajas_DIRGA)
bajas_DIRGA_sinenlace <- stringdist_join(
bancos_bajas,
bancos_DIRGA,
by = c("NIF_Entidad"="nif","Cod_Prov"="provincia","Cod_Mun"="codigo_concello","via2"="via2"),
method = "lv",
max_dist = 4,
distance_col = "distancia"
)
bajas_DIRGA_sinenlace <- stringdist_join(
bancos_bajas,
bancos_DIRGA,
by = c("NIF_Entidad"="nif","Cod_Prov"="provincia","Cod_Mun"="codigo_concello","via2"="via2"),
method = "lv",
max_dist = 4,
distance_col = "distancia"
)
View(bajas_DIRGA)
rm(bajas_DIRGA_sinenlace)
bajas_DIRGA_sinenlace <- stringdist_join(
bancos_bajas,
bancos_DIRGA,
by = c("NIF_Entidad"="nif","Cod_Prov"="provincia","Cod_Mun"="codigo_concello","via2"="via2"),
method = "lv",
max_dist = 4,
distance_col = "distancia"
)
View(bajas_DIRGA)
bajas_DIRGA <-
bajas_DIRGA %>% filter(NIF_Entidad == nif,
Cod_Prov == provincia,
Cod_Mun == codigo_concello,
abs(Nvia - nvia) < 3)
bajas_DIRGA_sinenlace <-
bajas_DIRGA_sinenlace %>% filter(NIF_Entidad == nif,
Cod_Prov == provincia,
Cod_Mun == codigo_concello,
abs(Nvia - nvia) < 3)
bajas_no_enlazan <-
left_join(bancos_bajas, bajas_DIRGA, by = c("ID.x"))
bajas_no_enlazan <-
bajas_no_enlazan %>% filter(is.na(nif_establecimiento))
bajas_no_enlazan <- bajas_no_enlazan %>% select (ID.x:enlace)
duplicados <-
bajas_DIRGA %>% group_by(ID.x) %>% filter(n() > 1) %>% ungroup()
bajas_DIRGA <-
bajas_DIRGA %>% group_by(ID.x) %>% filter(n() == 1) %>% ungroup()
bajas_DIRGA <- rbind(bajas_DIRGA, filter(duplicados, Nvia == nvia))
write_xlsx(bajas_DIRGA, "Bajas_DIRGA_lv.xlsx")
write_xlsx(bajas_no_enlazan, "Bajas_no_enlazan_lv.xlsx")
bancos_altas <- select(bancos_altas,-ends_with(".x"))
patron <- str_to_upper(patron)
bancos_altas <- bancos_altas %>%
mutate(Cod_Mun = str_pad(Cod_Mun, width = 3, pad = "0")) %>%
mutate(tipo_via = str_sub(Domicilio, 1, 2),
via = str_to_upper(str_sub(Domicilio, 4))) %>%
mutate(via = str_replace_all(via, paste(patron, collapse = "|"), ""))
bancos_altas <- bancos_altas %>%
mutate(nvia = str_extract(via, "\\d+")) %>%
mutate(nvia = as.numeric(nvia))
bancos_altas <- bancos_altas %>%
mutate(via = str_remove_all(str_trim(via), "[^[:alpha:]\\s]"))
bancos_altas <-
bancos_altas %>%
select(NIF_Entidad, Cod_Prov, Cod_Mun, tipo_via, via, nvia, CP = CP.y) %>%
mutate(Cod_Prov = as.character(Cod_Prov),
CP = as.character(CP),
cnae = "6419")
# Gardamos a t치boa de altas nun ficheiro Excel
write_xlsx(bancos_altas, "Bancos_altas.xlsx")
bajas_DIRGA_sinenlace <- stringdist_join(
bancos_bajas,
bancos_DIRGA,
by = c("NIF_Entidad"="nif","Cod_Prov"="provincia","Cod_Mun"="codigo_concello","via2"="via2"),
method = "jaccard",
max_dist = 4,
distance_col = "distancia"
)
bajas_DIRGA <-
bajas_DIRGA %>% filter(NIF_Entidad == nif,
Cod_Prov == provincia,
Cod_Mun == codigo_concello,
abs(Nvia - nvia) < 3)
